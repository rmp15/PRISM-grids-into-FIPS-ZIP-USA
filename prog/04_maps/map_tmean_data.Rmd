---
title: "Map mean temperature data example"
output: html_document
---

# Clear environment and declare root directory
```{r}
rm(list=ls())

project.folder = paste0(print(here::here()),'/')
```

# Load packages
```{r}
library(maptools)
library(mapproj)
library(rgeos)
library(rgdal)
library(RColorBrewer)
library(ggplot2)
library(raster)
library(sp)
library(plyr)
library(graticule)
library(zoo)
library(dplyr)
library(MetBrewer)
```

# Details of results to load
```{r}
year = 2020
dname = 'tmean'
time.res = 'daily'
space.res = 'fips'
```

# File input and output file structure
```{r}
# input directory
dir.input = paste0(project.folder,"output/")
if(space.res=='zip'){dir.input=paste0(dir.input,'zip/',state,'/',dname,'/')}
if(space.res=='fips'){dir.input=paste0(dir.input,'fips/',dname,'/')}
ifelse(!dir.exists(dir.input), dir.create(dir.input), FALSE)

# output directory
dir.output = paste0(project.folder,'maps/tmean/')
ifelse(!dir.exists(dir.output), dir.create(dir.output,recursive=TRUE), FALSE)
```

# Load data
```{r}
if(space.res=='zip'){
    dat = readRDS(paste0(dir.input,'weighted_area_raster_zip_',state,'_',dname,'_',time.res,'_',as.character(year),'.rds'))
}
if(space.res=='fips'){
    dat = readRDS(paste0(dir.input,'weighted_area_raster_fips_',dname,'_',time.res,'_',as.character(year),'.rds'))
}
```

# summarise by mean annual temperature and number of days over a threshold (>30°C) in the selected file
```{r}
dat_mean = dat %>%
  group_by(fips) %>%
  summarise(mean = mean(get(dname))) %>%
  mutate(fips=as.numeric(as.character(fips)))

threshold = 30
  
dat_threshold = dat %>%
  mutate(count=ifelse(get(dname)>threshold,1,0)) %>%
  group_by(fips) %>%
  tally(count) %>%
  rename(count=n) %>%
  mutate(fips=as.numeric(as.character(fips)))
```

# histograms of summarised data for sanity check (not pretty but does the job)
```{r}
hist(dat_mean$mean)

hist(dat_threshold$count)
```

# Prepare map structure
```{r}
# for map theme to plot in ggplot
theme_map <- function(base_size=15, base_family=""){
    require(grid)
    theme_bw(base_size=base_size,base_family=base_family) %+replace%
    theme(axis.line=element_blank(),
    axis.text=element_blank(),
    axis.ticks=element_blank(),
    axis.title=element_blank(),
    panel.background=element_blank(),
    panel.border=element_blank(),
    panel.grid=element_blank(),
    panel.margin=unit(0,"lines"),
    plot.background=element_blank(),
    legend.position = 'bottom'
    )
}

# load shapefile of entire United States by county
us.national = readOGR(dsn=paste0(project.folder,"data/shapefiles/cb_2015_us_county_500k"),layer="cb_2015_us_county_500k")

# reproject shapefile
us.national = spTransform(us.national, CRS("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs"))

# remove non-mainland territories (assuming it's for entire mainland US)
us.main = us.national[!us.national$STATEFP %in% c("02","15","60","66","69","71","72","78"),]

# fortify to prepare for plotting in ggplot
map = fortify(us.main)

# extract data from shapefile
us.main@data$id = rownames(us.main@data)
shapefile.data = us.main@data

# merge selected data to map_create dataframe for colouring of ggplot
USA.df = merge(map, shapefile.data, by='id')
USA.df$GEOID = as.integer(as.character(USA.df$GEOID))
```

# Prepare summary maps
```{r}
# merge map with mean values
USA.df.merged.mean = merge(USA.df,dat_mean,by.x='GEOID',by.y='fips',all.x=TRUE)
USA.df.merged.mean = with(USA.df.merged.mean, USA.df.merged.mean[order(id,order),])

# merge map with threshold values
USA.df.merged.threshold = merge(USA.df,dat_threshold,by.x='GEOID',by.y='fips',all.x=TRUE)
USA.df.merged.threshold = with(USA.df.merged.threshold, USA.df.merged.threshold[order(id,order),])
```

# Prepare colors and legends of maps
```{r}
if(dname=='tmean'){
  legend.mean = 'Annual mean temperature (°C)'
  colors.mean = rev(met.brewer(name='Cassatt1'))

  legend.threshold = paste0('Number of days over ', threshold ,'°C')
  colors.threshold = met.brewer(name='Hokusai3')
}
```

# Plot mean map 
```{r}
plot.mean = ggplot() +
    geom_polygon(data=USA.df.merged.mean,aes(x=long,y=lat,group=group,fill=mean),color='black',size=0.001) +
    guides(fill = guide_colorbar(direction = "horizontal", title.position="left",barwidth = 10, 
                                 barheight = 1,title.vjust = 0.8, title = legend.mean),legend.text=element_text(size=10)) +
  scale_fill_gradientn(colors = colors.mean) +
    coord_fixed() + xlab('') + ylab('') + theme_bw() +
    theme(panel.grid.major = element_blank(),
        axis.text.x = element_text(angle=90), axis.ticks.x=element_blank(),legend.text=element_text(size=20),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black"),strip.background = element_blank(),legend.justification='center',
        legend.position = 'bottom', legend.background = element_rect(fill="white", size=.5, linetype="dotted")) +
    theme_map()

pdf(paste0(dir.output,'map_annual_mean_',dname,'_',time.res,'_',as.character(year),'.pdf'),paper='a4r',height=0,width=0)
print(plot.mean)
dev.off()

plot.mean
```

# Plot threshold map 
```{r}
plot.threshold = ggplot() +
    geom_polygon(data=USA.df.merged.threshold,aes(x=long,y=lat,group=group,fill=count),color='black',size=0.01) +
    guides(fill = guide_colorbar(direction = "horizontal", title.position="left",barwidth = 10, 
                                 barheight = 1,title.vjust = 0.8, title = legend.threshold),legend.text=element_text(size=10)) +
  scale_fill_gradientn(colors = colors.threshold) +
    coord_fixed() + xlab('') + ylab('') + theme_bw() +
    theme(panel.grid.major = element_blank(),
        axis.text.x = element_text(angle=90), axis.ticks.x=element_blank(),legend.text=element_text(size=20),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black"),strip.background = element_blank(),legend.justification='center',
        legend.position = 'bottom', legend.background = element_rect(fill="white", size=.5, linetype="dotted")) +
    theme_map()

pdf(paste0(dir.output,'map_annual_threshold_over_',threshold,'_',dname,'_',time.res,'_',as.character(year),'.pdf'),paper='a4r',height=0,width=0)
print(plot.threshold)
dev.off()

plot.threshold
```